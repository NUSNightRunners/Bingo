{% extends "layout.html" %}
{% block content %}
<div class="container py-4" style="max-width: 900px;">

  <h2 class="mb-4">ğŸ“Œ é¢˜ç›®è¯¦æƒ…ï¼š<code>({{ problem.row_index }}, {{ problem.col_index }})</code></h2>

  <div class="card shadow-sm mb-4">
    <div class="card-header bg-light"><strong>ğŸ“– é¢˜ç›®å†…å®¹</strong></div>
    <div class="card-body bg-white">
      <div class="border rounded p-3" style="white-space: pre-wrap;">{{ question | safe }}</div>
    </div>
  </div>

  {% if submission %}
  <div class="card mb-4 border-{{ 'success' if submission.status == 'archived' else 'danger' if submission.status == 'rejected' else 'warning' }}">
    <div class="card-header bg-light">
      <strong>ğŸ“¥ å½“å‰æäº¤çŠ¶æ€</strong>
    </div>
    <div class="card-body">
      <ul class="list-unstyled mb-3">
        <li>ğŸ§‘ æäº¤äººï¼š<strong>{{ user_map[submission.user_id].username if submission.user_id in user_map else "æœªçŸ¥ç”¨æˆ·" }}</strong></li>
        <li>â° æäº¤æ—¶é—´ï¼š{{ submission.submitted_at.strftime("%Y-%m-%d %H:%M") if submission.submitted_at else "æœªçŸ¥æ—¶é—´" }}</li>
        <li>ğŸ§¾ çŠ¶æ€ï¼š
          {% if submission.status == "archived" %}
            <span class="badge bg-success">âœ… å·²å½’æ¡£</span>
          {% elif submission.status == "rejected" %}
            <span class="badge bg-danger">âŒ è¢«æ‹’ç»</span>
          {% else %}
            <span class="badge bg-warning text-dark">âŒ› å¾…å®¡æ ¸</span>
          {% endif %}
        </li>
      </ul>

      {% if submission.description %}
        <div class="mb-3"><strong>ğŸ“„ æè¿°ï¼š</strong><br>{{ submission.description | e }}</div>
      {% endif %}

      {% if submission.image_path %}
        <div class="mb-3"><strong>ğŸ“ é™„ä»¶ï¼š</strong><br>
          {% if submission.image_path.endswith('.mp4') or submission.image_path.endswith('.webm') %}
            <video width="300" class="rounded border" controls>
              <source src="/{{ submission.image_path }}">
            </video>
          {% else %}
            <img src="/{{ submission.image_path }}" class="img-fluid rounded border" style="max-width: 300px;">
          {% endif %}
        </div>
      {% endif %}

      {% if submission.status == "rejected" %}
        <div class="alert alert-danger mt-3">âš ï¸ ä¸Šæ¬¡æäº¤è¢«æ‹’ç»ï¼Œè¯·ä¿®æ”¹åé‡è¯•ã€‚</div>
      {% elif submission.status == "archived" %}
        <div class="alert alert-success mt-3">âœ… æœ¬é¢˜å·²å½’æ¡£ï¼Œå›¢é˜Ÿæäº¤å·²å®Œæˆã€‚</div>
      {% endif %}
    </div>
  </div>
  {% else %}
    <div class="alert alert-secondary">ğŸ“­ å½“å‰é¢˜ç›®å°šæœªæœ‰æäº¤è®°å½•ã€‚</div>
  {% endif %}

  {% if not is_team_archived %}
  <div class="card mb-5 shadow-sm">
    <div class="card-header bg-light"><strong>ğŸ“¤ æäº¤ä½ çš„ç­”æ¡ˆ</strong></div>
    <div class="card-body">
      <form method="POST" enctype="multipart/form-data" id="uploadForm">
        <div class="mb-3">
          <label class="form-label">æè¿°ï¼ˆå¯é€‰ï¼‰</label>
          <textarea name="description" class="form-control" rows="3">{{ submission.description if submission else "" }}</textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">å›¾ç‰‡/è§†é¢‘é™„ä»¶ï¼ˆå¯é€‰ï¼‰</label>
          <input type="file" name="image" class="form-control">
          <small class="form-text text-muted">* è¯·è‡³å°‘å¡«å†™æè¿°æˆ–ä¸Šä¼ ä¸€ä¸ªé™„ä»¶</small>
        </div>

        <div class="progress mt-3" style="height: 20px; display: none;" id="progressContainer">
          <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" id="progressBar">0%</div>
        </div>

        <button type="submit" class="btn btn-primary mt-3">ğŸ“¨ æäº¤</button>
      </form>
    </div>
  </div>
  {% else %}
    <div class="alert alert-info">ğŸ“Œ æœ¬é¢˜å·²å½’æ¡£ï¼Œå›¢é˜Ÿæˆå‘˜ä¸å¯å†æ¬¡æäº¤ã€‚</div>
  {% endif %}

  {% if all_team_submissions|length > 1 %}
  <hr>
  <h4 class="mt-5 mb-3">ğŸ“š æäº¤å†å²è®°å½•</h4>
  <div class="table-responsive">
    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>æäº¤äºº</th>
          <th>æ—¶é—´</th>
          <th>çŠ¶æ€</th>
          <th>æè¿°</th>
          <th>é™„ä»¶</th>
          <th>ç®¡ç†å‘˜è¯„è®º</th>
        </tr>
      </thead>
      <tbody>
        {% for s in all_team_submissions %}
          {% set review = review_map.get(s.id) %}
          {% set is_superseded = review and "è¢«æ–°æäº¤è¦†ç›–" in (review.comment or "") %}
          <tr class="{% if is_superseded %}text-muted{% endif %}">
            <td>{{ user_map[s.user_id].username if s.user_id in user_map else "æœªçŸ¥ç”¨æˆ·" }}</td>
            <td>{{ s.submitted_at.strftime("%Y-%m-%d %H:%M") }}</td>
            <td>
              {% if s.status == "archived" %}âœ… å·²å½’æ¡£
              {% elif s.status == "rejected" %}
                {% if is_superseded %}ğŸ“ è¢«æ–°æäº¤è¦†ç›–{% else %}âŒ è¢«æ‹’ç»{% endif %}
              {% elif s.status == "pending" %}âŒ› å¾…å®¡æ ¸{% endif %}
            </td>
            <td>{{ s.description or '-' }}</td>
            <td>
              {% if s.image_path %}
                {% if s.image_path.endswith('.mp4') or s.image_path.endswith('.webm') %}
                  <video width="100" controls><source src="/{{ s.image_path }}"></video>
                {% else %}
                  <img src="/{{ s.image_path }}" width="100" class="img-thumbnail">
                {% endif %}
              {% else %}-{% endif %}
            </td>
            <td>{{ review.comment if review and review.comment else '-' }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

</div>

<script>
document.getElementById('uploadForm').addEventListener('submit', function(e) {
  e.preventDefault();

  const form = e.target;
  const formData = new FormData(form);
  const xhr = new XMLHttpRequest();

  const progressBar = document.getElementById('progressBar');
  const progressContainer = document.getElementById('progressContainer');
  progressContainer.style.display = 'block';

  xhr.upload.addEventListener('progress', function(e) {
    if (e.lengthComputable) {
      const percent = Math.round((e.loaded / e.total) * 100);
      progressBar.style.width = percent + '%';
      progressBar.innerText = percent + '%';
    }
  });

  xhr.onload = function() {
    if (xhr.status === 200) {
      location.reload();
    } else {
      alert('ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  };

  xhr.open('POST', window.location.href);
  xhr.send(formData);
});
</script>
{% endblock %}
