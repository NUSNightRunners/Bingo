{% extends "layout.html" %}
{% block content %}
<div class="container py-4">
  <h2 class="mb-4">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h2>

  <!-- ğŸ” æœç´¢æ  -->
  <form method="get" class="row g-2 mb-4">
    <div class="col-sm-4">
      <input type="text" class="form-control" name="q" placeholder="æœç´¢ç”¨æˆ·å..." value="{{ search_query }}">
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary">ğŸ” æœç´¢</button>
    </div>
  </form>

  <!-- å¯¼å…¥ç”¨æˆ· + è®¾ç½®å›¢é˜Ÿæ•° -->
  <div class="row mb-4">
    <div class="col-md-6 mb-3">
      <div class="card">
        <div class="card-header bg-light">ğŸ“¥ å¯¼å…¥ç”¨æˆ· CSV</div>
        <div class="card-body">
          <form action="{{ url_for('admin_bp.import_users') }}" method="post" enctype="multipart/form-data">
            <div class="input-group">
              <input type="file" class="form-control" name="file" required>
              <button type="submit" class="btn btn-success">ä¸Šä¼ </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-md-6 mb-3">
      <div class="card">
        <div class="card-header bg-light">ğŸ”§ è®¾ç½®å›¢é˜Ÿæ€»æ•°</div>
        <div class="card-body">
          <form method="post" action="{{ url_for('admin_bp.set_team_count') }}">
            <select name="team_count" class="form-select" onchange="this.form.submit()">
              {% for i in range(1, 11) %}
                <option value="{{ i }}" {% if i == team_count %}selected{% endif %}>{{ i }} ä¸ªå›¢é˜Ÿ</option>
              {% endfor %}
            </select>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- åˆ›å»ºæ–°ç”¨æˆ·æŒ‰é’® -->
  <div class="mb-4">
    <a href="{{ url_for('admin_bp.create_user') }}" class="btn btn-primary">â• æ–°å»ºç”¨æˆ·</a>
  </div>

  <!-- ç”¨æˆ·è¡¨æ ¼ -->
  <div class="table-responsive mb-4">
    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>ç”¨æˆ·å</th>
          <th>ç®¡ç†å‘˜</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
        <tr>
          <td>{{ user.id }}</td>
          <td>
            {{ user.username }}
            {% if user.is_admin %}<span class="badge bg-primary ms-1">ğŸ›¡ï¸ ç®¡ç†å‘˜</span>{% endif %}
            {% if user.id in spy_ids %}<span class="badge bg-danger ms-1">ğŸ•µï¸ é—´è°</span>{% endif %}
          </td>
          <td>
            {% if user.is_admin %}
              <span class="badge bg-success">âœ…</span>
            {% else %}
              <span class="badge bg-secondary">âŒ</span>
            {% endif %}
          </td>
          <td>
            {% if not user.is_admin %}
              <a href="{{ url_for('admin_bp.set_admin', user_id=user.id) }}" class="btn btn-sm btn-outline-primary">è®¾ä¸ºç®¡ç†å‘˜</a>
            {% else %}
              <a href="{{ url_for('admin_bp.unset_admin', user_id=user.id) }}" class="btn btn-sm btn-outline-secondary">æ’¤é”€ç®¡ç†å‘˜</a>
            {% endif %}
            <a href="{{ url_for('admin_bp.reset_password', user_id=user.id) }}" class="btn btn-sm btn-outline-warning ms-1">é‡è®¾å¯†ç </a>
            <a href="{{ url_for('admin_bp.delete_user', user_id=user.id) }}" class="btn btn-sm btn-outline-danger ms-1"
               onclick="return confirm('ç¡®å®šåˆ é™¤è¯¥ç”¨æˆ·ï¼Ÿ');">ğŸ—‘ åˆ é™¤</a>
            <a href="{{ url_for('admin_bp.set_spy', user_id=user.id) }}" class="btn btn-sm btn-outline-dark ms-1">
              {% if user.id in spy_ids %}âŒ å–æ¶ˆé—´è°{% else %}ğŸ•µï¸ è®¾ä¸ºé—´è°{% endif %}
            </a>

            {% if not user.is_admin %}
              <form method="post" action="{{ url_for('admin_bp.assign_team') }}" style="display:inline;">
                <input type="hidden" name="user_id" value="{{ user.id }}">
                <select name="team_id" class="form-select form-select-sm d-inline w-auto ms-1" onchange="this.form.submit()">
                  {% for team in teams %}
                    <option value="{{ team.id }}"
                      {% if user.id in user_team_map and user_team_map[user.id] == team.id %}selected{% endif %}>
                      {{ team.name }}
                    </option>
                  {% endfor %}
                </select>
              </form>
            {% else %}
              <span class="text-muted ms-2">ï¼ˆç®¡ç†å‘˜å›ºå®šå›¢é˜Ÿï¼‰</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- åˆ†é¡µæ§ä»¶ -->
  {% if pagination.pages > 1 %}
  <nav>
    <ul class="pagination">
      <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('admin_bp.user_list', page=pagination.prev_num, q=search_query) }}">Â« ä¸Šä¸€é¡µ</a>
      </li>
      {% for p in range(1, pagination.pages + 1) %}
        <li class="page-item {% if p == pagination.page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('admin_bp.user_list', page=p, q=search_query) }}">{{ p }}</a>
        </li>
      {% endfor %}
      <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('admin_bp.user_list', page=pagination.next_num, q=search_query) }}">ä¸‹ä¸€é¡µ Â»</a>
      </li>
    </ul>
  </nav>
  {% endif %}

  <!-- å›¢é˜Ÿæˆå‘˜æ¦‚è§ˆ -->
  <div class="card mt-5 mb-4">
    <div class="card-header bg-info text-white">ğŸ“‹ å›¢é˜Ÿæˆå‘˜æ¦‚è§ˆ</div>
    <div class="card-body">
      {% for team in teams %}
        <p><strong>{{ team.name }}</strong>ï¼š
          {% for user in team_members[team.id] %}
            {{ user.username }}{% if user.id in spy_ids %} ğŸ•µï¸{% endif %}{% if not loop.last %}, {% endif %}
          {% else %}
            <em>æš‚æ— æˆå‘˜</em>
          {% endfor %}
        </p>
      {% endfor %}
    </div>
  </div>

  <!-- ç®¡ç†å‘˜å›¢é˜Ÿ -->
  <div class="card mb-4">
    <div class="card-header bg-secondary text-white">ğŸ›¡ï¸ ç®¡ç†å‘˜å›¢é˜Ÿ</div>
    <div class="card-body">
      <p>
        {% for user in users if user.is_admin %}
          {{ user.username }}{% if not loop.last %}, {% endif %}
        {% endfor %}
      </p>
    </div>
  </div>

  <!-- é—´è°å›¢é˜Ÿ -->
  <div class="card mb-4">
    <div class="card-header bg-danger text-white">ğŸ•µï¸ é—´è°å›¢é˜Ÿ</div>
    <div class="card-body">
      <p>
        {% for user in users if user.id in spy_ids %}
          {{ user.username }}{% if not loop.last %}, {% endif %}
        {% else %}
          <em>æš‚æ— é—´è°</em>
        {% endfor %}
      </p>
    </div>
  </div>
</div>
{% endblock %}
