{% extends "layout.html" %}
{% block content %}
<div class="container py-4" style="max-width: 1000px;">

  <!-- æœç´¢æ  -->
  <div class="mb-3">
    <input type="text" id="searchInput" class="form-control table-search-bar" placeholder="ğŸ” æœç´¢ç”¨æˆ·åæˆ–é¢˜ç›®ä½ç½®..." onkeyup="filterTable()">
  </div>

  <!-- ğŸ—‚ï¸ å¾…å®¡æ ¸æäº¤ -->
  <div class="card mb-5 shadow-sm">
    <div class="card-header bg-warning text-dark fw-bold">ğŸ—‚ï¸ å¾…å®¡æ ¸æäº¤</div>
    <div class="card-body p-0">
      {% if pending %}
      <div class="table-responsive">
        <table id="reviewTable" class="table table-hover align-middle m-0">
            <thead class="table-light">
                <tr>
                  <th>ç©å®¶</th>
                  <th>å›¢é˜Ÿ</th>
                  <th>é¢˜ç›®ä½ç½®</th>
                  <th>æäº¤æ—¶é—´</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                {% for sub, prob, user, team_id in pending %}
                <tr>
                  <td>{{ user.username }}</td>
                  <td>{{ team_map[team_id].name if team_id in team_map else "æœªåˆ†é…" }}</td>
                  <td>{{ prob.row_index }},{{ prob.col_index }}</td>
                  <td>{{ sub.submitted_at.strftime("%Y-%m-%d %H:%M") }}</td>
                  <td>
                    <a href="{{ url_for('admin_bp.review_submission', submission_id=sub.id) }}"
                       class="btn btn-sm btn-outline-primary">ğŸ“ å®¡æ ¸</a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
              
        </table>
      </div>
      {% else %}
        <div class="p-3 text-muted">æš‚æ— å¾…å®¡æ ¸æäº¤ã€‚</div>
      {% endif %}
    </div>
  </div>

  <!-- ğŸ“œ å·²å®¡æ ¸è®°å½• -->
  <div class="card shadow-sm">
    <div class="card-header bg-success text-white fw-bold">ğŸ“œ å·²å®¡æ ¸è®°å½•</div>
    <div class="card-body p-0">
      {% if reviewed %}
      <div class="table-responsive">
        <table id="reviewedTable" class="table table-bordered align-middle m-0">
          <thead class="table-light">
            <tr>
              <th>ç©å®¶</th>
              <th>å›¢é˜Ÿ</th>
              <th>é¢˜ç›®</th>
              <th>å®¡æ ¸ç»“æœ</th>
              <th>è¯„è®º</th>
              <th>é—´è°å¹²æ‰°</th>
              <th>å®¡æ ¸äºº</th>
              <th>å®¡æ ¸æ—¶é—´</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            {% for sub, prob, user, review, admin, is_final, team_id in reviewed %}
            <tr>
              <td>{{ user.username }}</td>
              <td>{{ team_map[team_id].name if team_id in team_map else "æœªåˆ†é…" }}</td>
              <td>{{ prob.row_index }},{{ prob.col_index }}</td>
              <td>
                {% if review.result in ["approved", "approve"] %}
                  <span class="badge bg-success">âœ… é€šè¿‡</span>
                {% elif review.result in ["rejected", "reject"] %}
                  <span class="badge bg-danger">âŒ æ‹’ç»</span>
                {% else %}
                  <span class="badge bg-secondary">â“ æœªçŸ¥</span>
                {% endif %}
                {% if is_final %}
                  <span class="badge bg-primary">æœ€ç»ˆ</span>
                {% endif %}
              </td>
              <td>{{ review.comment or '-' }}</td>
              <td>{% if review.is_spy_attack %}ğŸ•µï¸ æ˜¯{% else %}-{% endif %}</td>
              <td>{{ admin.username if admin else '-' }}</td>
              <td>{{ review.reviewed_at.strftime("%Y-%m-%d %H:%M") if review and review.reviewed_at else '-' }}</td>
              <td>
                <a href="{{ url_for('admin_bp.view_submission_history', user_id=user.id, problem_id=prob.id) }}"
                   class="btn btn-sm btn-outline-secondary">ğŸ” æŸ¥çœ‹è¯¦æƒ…</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="p-3 text-muted">æš‚æ— å®¡æ ¸è®°å½•ã€‚</div>
      {% endif %}
    </div>
  </div>

</div>

<!-- âœ… æœç´¢åŠŸèƒ½ JS -->
<script>
function filterTable() {
  const input = document.getElementById("searchInput");
  const filter = input.value.toLowerCase();
  const tables = ["reviewTable", "reviewedTable"];

  tables.forEach(tableId => {
    const table = document.getElementById(tableId);
    if (!table) return;
    const rows = table.getElementsByTagName("tr");
    for (let i = 1; i < rows.length; i++) {
      const text = rows[i].innerText.toLowerCase();
      rows[i].style.display = text.includes(filter) ? "" : "none";
    }
  });
}
</script>
{% endblock %}
