{% extends "layout.html" %}
{% block content %}
<div class="container py-4">

  <h2 class="mb-4">ğŸ“œ æäº¤è®°å½•è¯¦æƒ…</h2>

  <!-- ğŸ§© åŸºæœ¬é¢˜ç›®ä¿¡æ¯ -->
  <div class="mb-4">
    <p><strong>ç©å®¶ï¼š</strong> {{ user.username }}</p>
    <p><strong>é¢˜ç›®ä½ç½®ï¼š</strong> <code>({{ problem.row_index }}, {{ problem.col_index }})</code></p>
    <p><strong>é¢˜ç›®å†…å®¹ï¼š</strong></p>
    <div class="border rounded p-3 bg-light" style="white-space: pre-wrap;">
      {{ problem.normal_question | safe }}
    </div>
  </div>

  <hr>

  <!-- ğŸ” å¤šæ¬¡æäº¤å†å² -->
  {% for sub in submissions %}
    {% set value = review_map.get(sub.id) %}
    {% set review = value[0] if value else None %}
    {% set admin = value[1] if value else None %}
    {% set is_superseded = review and "è¢«æ–°æäº¤è¦†ç›–" in (review.comment or "") %}

    <div class="card mb-4 {% if is_superseded %}bg-light text-muted{% endif %}">
      <div class="card-header">
        <strong>ğŸ“¥ ç¬¬ {{ loop.index }} æ¬¡æäº¤</strong> â€“ {{ sub.submitted_at.strftime("%Y-%m-%d %H:%M") }}
      </div>

      <div class="card-body">
        <div class="row">
          <!-- å·¦ä¾§å†…å®¹ -->
          <div class="col-md-8">

            <!-- ğŸ¥ é™„ä»¶ -->
            <p class="fw-bold">ğŸ“ é™„ä»¶</p>
            {% if sub.image_path %}
              {% if sub.image_path.endswith('.mp4') or sub.image_path.endswith('.webm') or sub.image_path.endswith('.mov') %}
                <video width="100%" class="rounded border mb-3" controls>
                  <source src="/{{ sub.image_path }}">
                </video>
              {% else %}
                <img src="/{{ sub.image_path }}" class="rounded border img-fluid mb-3" style="max-width: 300px;">
              {% endif %}
            {% else %}
              <p><em>æœªä¸Šä¼ é™„ä»¶</em></p>
            {% endif %}

            <!-- ğŸ“„ æè¿° -->
            <p class="fw-bold">ğŸ“„ æè¿°</p>
            <div class="border p-2 bg-white rounded mb-3" style="white-space: pre-wrap;">
              {{ sub.description | safe if sub.description else "ï¼ˆæ— æè¿°ï¼‰" }}
            </div>

            <!-- ğŸ’¬ å®¡æ ¸è¯„è®º -->
            <p class="fw-bold">ğŸ’¬ å®¡æ ¸è¯„è®º</p>
            <div class="border p-2 bg-white rounded" style="white-space: pre-wrap;">
              {{ review.comment | safe if review and review.comment else "ï¼" }}
            </div>

          </div>

          <!-- å³ä¾§çŠ¶æ€ä¿¡æ¯ -->
          <div class="col-md-4">
            <p class="fw-bold">ğŸ§¾ å®¡æ ¸çŠ¶æ€</p>
            {% if review and review.result in ['approve', 'approved'] %}
              <span class="badge bg-success fs-6">âœ… å·²é€šè¿‡</span>
            {% elif review and review.result in ['reject', 'rejected'] %}
              <span class="badge bg-danger fs-6">âŒ è¢«æ‹’ç»</span>
            {% else %}
              <span class="badge bg-secondary fs-6">âŒ› å¾…å®¡æ ¸</span>
            {% endif %}

            {% if is_superseded %}
              <div class="text-muted mt-2">ğŸ“„ æ­¤æäº¤å·²è¢«åç»­æäº¤è¦†ç›–</div>
            {% endif %}

            <hr>
            <p><strong>ğŸ‘¤ å®¡æ ¸äººï¼š</strong><br>{{ admin.username if admin else "ï¼" }}</p>
            <p><strong>ğŸ•µï¸ é—´è°å¹²æ‰°ï¼š</strong><br>{% if review and review.is_spy_attack %}æ˜¯{% else %}ï¼{% endif %}</p>
            <p><strong>â° å®¡æ ¸æ—¶é—´ï¼š</strong><br>{{ review.reviewed_at.strftime("%Y-%m-%d %H:%M") if review else "ï¼" }}</p>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}

</div>
{% endblock %}
