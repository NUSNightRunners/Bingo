{% extends "layout.html" %}
{% block content %}
<div class="container py-4" style="max-width: 1100px;">

  <!-- æ’åºæ§åˆ¶ -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">ğŸ‘¥ å›¢é˜Ÿé¢æ¿</h2>
    <div class="btn-group">
      <button class="btn btn-outline-secondary btn-sm" onclick="sortTeams('total')">ğŸ“„ æäº¤æ•°</button>
      <button class="btn btn-outline-secondary btn-sm" onclick="sortTeams('accuracy')">ğŸ“Š æ­£ç¡®ç‡</button>
      <button class="btn btn-outline-secondary btn-sm" onclick="sortTeams('bingo')">ğŸ¯ Bingo æ•°</button>
    </div>
  </div>

  <!-- å›¢é˜Ÿå¡ç‰‡ -->
  <div id="teamCards" class="row row-cols-1 row-cols-md-2 g-4">
    {% for team in teams %}
    <div class="col team-card" data-total="{{ team_stats[team.id].total }}"
         data-accuracy="{% if team_stats[team.id].total > 0 %}{{ (team_stats[team.id].passed / team_stats[team.id].total * 100) | round(2) }}{% else %}0{% endif %}"
         data-bingo="{{ team_stats[team.id].bingo }}">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <strong>{{ team.name }}</strong>
        </div>
        <div class="card-body">
          <p><strong>æˆå‘˜ï¼š</strong>
            {% for user, is_spy in team_members[team.id] %}
              <span class="badge bg-secondary me-1">{{ user.username }}{% if is_spy %} ğŸ•µï¸{% endif %}</span>
            {% else %}
              <em class="text-muted">æš‚æ— æˆå‘˜</em>
            {% endfor %}
          </p>
          <p class="mb-0 small text-muted">
            ğŸ“„ æäº¤ï¼š<strong>{{ team_stats[team.id].total }}</strong> |
            âœ… é€šè¿‡ï¼š<strong>{{ team_stats[team.id].passed }}</strong> |
            âŒ æ‹’ç»ï¼š<strong>{{ team_stats[team.id].rejected }}</strong> |
            ğŸ¯ Bingoï¼š<strong>{{ team_stats[team.id].bingo }}</strong> |
            ğŸ“Š æ­£ç¡®ç‡ï¼š
            {% if team_stats[team.id].total > 0 %}
              <strong>{{ (team_stats[team.id].passed / team_stats[team.id].total * 100) | round(2) }}%</strong>
            {% else %}
              <span class="text-muted">ï¼</span>
            {% endif %}
          </p>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- é—´è°é¢æ¿ -->
  <hr class="my-5">
  <h2 class="mb-4">ğŸ•µï¸ é—´è°é¢æ¿</h2>

  {% if spies %}
  <form method="post" action="{{ url_for('admin_bp.update_spy_scores') }}">
    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>ç”¨æˆ·å</th>
            <th>æ‰€å±å›¢é˜Ÿ</th>
            <th>é—´è°å¾—åˆ†</th>
            <th>è°ƒæ•´åˆ†æ•°</th>
          </tr>
        </thead>
        <tbody>
          {% for user, team_id in spies %}
          <tr>
            <td>{{ user.username }}</td>
            <td>
              {% set team = teams | selectattr("id", "equalto", team_id) | list | first %}
              {{ team.name if team else "æœªçŸ¥å›¢é˜Ÿ" }}
            </td>
            <td>
              {{ spy_scores.get(user.id, 0) }}
              {% if spy_scores.get(user.id, 0) >= 3 %}
                <span class="ms-1 text-danger">ğŸ§¨</span>
              {% elif spy_scores.get(user.id, 0) <= -2 %}
                <span class="ms-1 text-muted">ğŸ˜“</span>
              {% endif %}
            </td>
            <td>
              <input type="number" name="adjustments_{{ user.id }}" value="0" class="form-control form-control-sm" style="max-width: 80px;">
              <input type="hidden" name="user_ids" value="{{ user.id }}">
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <button type="submit" class="btn btn-success">ğŸ’¾ æäº¤ä¿®æ”¹</button>
  </form>
  {% else %}
    <p><em class="text-muted">å½“å‰æ²¡æœ‰è¢«è®¾ç½®ä¸ºé—´è°çš„ç”¨æˆ·ã€‚</em></p>
  {% endif %}
</div>

<!-- æ’åºè„šæœ¬ -->
<script>
function sortTeams(by) {
  const cards = Array.from(document.querySelectorAll(".team-card"));
  cards.sort((a, b) => {
    const va = parseFloat(a.dataset[by] || 0);
    const vb = parseFloat(b.dataset[by] || 0);
    return vb - va;
  });

  const container = document.getElementById("teamCards");
  cards.forEach(card => container.appendChild(card));
}
</script>
{% endblock %}
